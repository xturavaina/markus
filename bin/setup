#!/usr/bin/env bash
set -euo pipefail

if [ -f "../env/magento.env" ]; then
  # shellcheck disable=SC1091
  source "../env/magento.env"
else
  echo "Warning: magento.env file not found."
fi

MEM_BYTES=$(docker info -f '{{.MemTotal}}')
MEM_MB=$(( MEM_BYTES / 1000000 ))
(( MEM_MB < 6227 )) && echo "There must be at least 6GB of RAM allocated to Docker in order to continue." && exit 1

DOMAIN=${1:-magento.test}

bin/stop
bin/start --no-dev
[ $? != 0 ] && echo "Failed to start Docker services" && exit 1

# ❗️només si existeix
bin/clinotty 'test -f bin/magento && chmod u+x bin/magento || { echo "bin/magento not found; did create-project run?"; exit 1; }'

echo "Adding Magento modules to Composer allow-plugins directive..."
bin/clinotty composer config --no-plugins allow-plugins.magento/magento-composer-installer true
bin/clinotty composer config --no-plugins allow-plugins.magento/inventory-composer-installer true
bin/clinotty composer config --no-plugins allow-plugins.laminas/laminas-dependency-plugin true

echo "Running Magento setup:install..."
bin/setup-install "${DOMAIN}"

# ❌ amb bind mount NO cal copiar del contenidor
# bin/copyfromcontainer --all

echo "Forcing deploy of static content..."
bin/clinotty bin/magento setup:static-content:deploy -f

echo "Re-indexing..."
bin/clinotty bin/magento indexer:reindex

# echo "Setting base URL and SSL..."
# bin/setup-domain "${DOMAIN}"

echo "Fixing owner and permissions..."
bin/fixowns
bin/fixperms

echo "Flushing cache..."
bin/clinotty bin/magento cache:flush

echo "Installing cron (disabled by default)..."
bin/clinotty bin/magento cron:install

echo "Developer mode..."
bin/clinotty bin/magento deploy:mode:set developer

cp -r .vscode src/ || true

echo "Done. Frontend: https://${DOMAIN}/  Admin: https://${DOMAIN}/admin/"
echo "User: ${MAGENTO_ADMIN_USER:-admin}  Pass: ${MAGENTO_ADMIN_PASSWORD:-admin123}"
